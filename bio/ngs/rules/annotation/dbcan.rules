rule run_dbcan:
    input:
        "annotation/prodigal/{parameters}/{assembly}/proteins/proteins.faa"
    output:
        tsv = "annotation/dbCAN/{parameters}/{assembly}/hmm_result.tsv",
        dom_tsv = "annotation/dbCAN/{parameters}/{assembly}/hmm_result.dom.tsv",
        txt = "annotation/dbCAN/{parameters}/{assembly}/hmm_report.txt"
    params:
        dbcan_db = config["dbcan_rules"]["db_path"],
        hmmscan_params = config["dbcan_rules"]["hmmscan_params"]
    shell: 
        """{config[dbcan_rules][load_env]};
           input_basename=`basename {input}`;
           database_basename=`basename {params.dbcan_db}`;
           cp {params.dbcan_db}.h3* $SNIC_TMP/;
           cp {input} $SNIC_TMP/;
           hmmscan {params.hmmscan_params} --domtblout {output.dom_tsv} --tblout {output.tsv} $SNIC_TMP/$database_basename $SNIC_TMP/$input_basename > {output.txt}
        """

rule run_dbcan_all:
    input: expand("annotation/dbCAN/{parameters}/{assembly}/hmm_result.tsv", parameters=config["prodigal_rules"]["prodigal_params"], assembly=config["prodigal_rules"]["assemblies"])
